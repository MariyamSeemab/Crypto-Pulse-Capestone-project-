{% extends "base.html" %}

{% block title %}{% if coin_id %}{{ coin_id.title() }} Chart{% else %}Price Charts{% endif %} - CryptoPulse{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2>{% if coin_id %}{{ coin_id.title() }} Price Chart{% else %}Cryptocurrency Price Charts{% endif %}</h2>
        {% if coin_id and current_price and currency in current_price %}
        <div class="d-flex align-items-center gap-3">
            <h4 class="mb-0">{{ currency_symbol }}{{ "%.2f"|format(current_price[currency]) }}</h4>
            {% set change_key = currency + '_24h_change' %}
            {% if change_key in current_price %}
            <span class="badge {% if current_price[change_key] >= 0 %}bg-success{% else %}bg-danger{% endif %} fs-6">
                {% if current_price[change_key] >= 0 %}↗{% else %}↘{% endif %}
                {{ "%.2f"|format(current_price[change_key]) }}%
            </span>
            {% endif %}
        </div>
        {% endif %}
    </div>
    {% if coin_id %}
    <div class="btn-group" role="group">
        <button type="button" class="btn btn-outline-primary" onclick="loadChart(1)">1D</button>
        <button type="button" class="btn btn-outline-primary active" onclick="loadChart(7)">7D</button>
        <button type="button" class="btn btn-outline-primary" onclick="loadChart(30)">30D</button>
        <button type="button" class="btn btn-outline-primary" onclick="loadChart(90)">90D</button>
        <button type="button" class="btn btn-outline-primary" onclick="loadChart(365)">1Y</button>
        <button type="button" class="btn btn-outline-secondary" onclick="testChart()">Test Chart</button>
    </div>
    {% endif %}
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="priceChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Technical Indicators -->
<div class="row mt-4">
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h6>Price Statistics</h6>
            </div>
            <div class="card-body">
                <div id="priceStats">
                    <div class="d-flex justify-content-between">
                        <span>High (24h):</span>
                        <span id="high24h">-</span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>Low (24h):</span>
                        <span id="low24h">-</span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>Volume:</span>
                        <span id="volume24h">-</span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>Market Cap:</span>
                        <span id="marketCap">-</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h6>Technical Indicators</h6>
            </div>
            <div class="card-body">
                <div id="technicalIndicators">
                    <div class="d-flex justify-content-between">
                        <span>RSI (14):</span>
                        <span id="rsi">-</span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>MA (20):</span>
                        <span id="ma20">-</span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>MA (50):</span>
                        <span id="ma50">-</span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>Volatility:</span>
                        <span id="volatility">-</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h6>Trading Actions</h6>
            </div>
            <div class="card-body">
                <button class="btn btn-success w-100 mb-2" onclick="quickBuy()">
                    <i class="fas fa-plus"></i> Quick Buy $100
                </button>
                <button class="btn btn-warning w-100 mb-2" onclick="setAlert()">
                    <i class="fas fa-bell"></i> Set Price Alert
                </button>
                <button class="btn btn-info w-100" onclick="addToFavorites()">
                    <i class="fas fa-star"></i> Add to Favorites
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Price Alert Modal -->
<div class="modal fade" id="alertModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Set Price Alert{% if coin_id %} for {{ coin_id.title() }}{% endif %}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="alertForm">
                    <div class="mb-3">
                        <label for="alertPrice" class="form-label">Alert Price ({{ currency_symbol }})</label>
                        <input type="number" class="form-control" id="alertPrice" step="0.01" required>
                        {% if coin_id and current_price and currency in current_price %}
                        <small class="text-muted">Current price: {{ currency_symbol }}{{ "%.2f"|format(current_price[currency]) }}</small>
                        {% endif %}
                    </div>
                    <div class="mb-3">
                        <label for="alertType" class="form-label">Alert Type</label>
                        <select class="form-control" id="alertType">
                            <option value="above">Above</option>
                            <option value="below">Below</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveAlert()">Set Alert</button>
            </div>
        </div>
    </div>
</div>

<script>
{% if coin_id %}
let chart;
const coinId = '{{ coin_id }}';
let currentDays = parseInt('{{ days|default(7) }}');

// Initialize chart on page load
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, Chart.js available:', typeof Chart !== 'undefined');
    console.log('Canvas element found:', document.getElementById('priceChart') !== null);
    
    if (typeof Chart === 'undefined') {
        console.error('Chart.js is not loaded!');
        document.getElementById('priceChart').parentElement.innerHTML = 
            '<div class="alert alert-danger">Chart.js library failed to load. Please refresh the page.</div>';
        return;
    }
    
    loadChart(currentDays);
    loadPriceStats();
});

function loadChart(days) {
    currentDays = days;
    
    // Update active button
    document.querySelectorAll('.btn-group .btn').forEach(btn => btn.classList.remove('active'));
    if (typeof event !== 'undefined' && event.target) {
        event.target.classList.add('active');
    }
    
    // Get current currency from session or default to USD
    const currency = new URLSearchParams(window.location.search).get('currency') || 'usd';
    
    console.log('Loading chart for ' + coinId + ' with ' + days + ' days in ' + currency);
    
    fetch('/api/historical/' + coinId + '?days=' + days + '&currency=' + currency)
        .then(response => {
            console.log('API response status:', response.status);
            return response.json();
        })
        .then(response => {
            console.log('Historical data received:', response);
            if (response.data && response.data.length > 0) {
                updateChart(response.data, response.currency_symbol);
                calculateTechnicalIndicators(response.data);
            } else {
                console.error('No historical data received');
                showPlaceholderChart();
            }
        })
        .catch(error => {
            console.error('Error loading chart data:', error);
            showPlaceholderChart();
        });
}

function showPlaceholderChart() {
    const ctx = document.getElementById('priceChart');
    if (!ctx) {
        console.error('Canvas element not found for placeholder!');
        return;
    }
    
    const context = ctx.getContext('2d');
    
    if (chart) {
        chart.destroy();
    }
    
    try {
        // Create a simple chart with mock data
        chart = new Chart(context, {
            type: 'line',
            data: {
                labels: ['Day 1', 'Day 2', 'Day 3', 'Day 4', 'Day 5'],
                datasets: [{
                    label: coinId.toUpperCase() + ' Price (Demo)',
                    data: [1000, 1050, 980, 1100, 1080],
                    borderColor: 'rgb(75, 192, 192)',
                    backgroundColor: 'rgba(75, 192, 192, 0.1)',
                    tension: 0.1,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: false,
                        ticks: {
                            callback: function(value) {
                                return '$' + value.toFixed(2);
                            }
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': $' + context.parsed.y.toFixed(2);
                            }
                        }
                    }
                }
            }
        });
        
        console.log('Placeholder chart created successfully');
    } catch (error) {
        console.error('Error creating placeholder chart:', error);
        ctx.parentElement.innerHTML = '<div class="alert alert-info">Chart data unavailable. Error: ' + error.message + '</div>';
    }
}

function updateChart(data, currencySymbol = '$') {
    const ctx = document.getElementById('priceChart');
    if (!ctx) {
        console.error('Canvas element not found!');
        return;
    }
    
    const context = ctx.getContext('2d');
    if (!context) {
        console.error('Cannot get 2D context from canvas!');
        return;
    }
    
    if (chart) {
        chart.destroy();
    }
    
    // Ensure data is in the correct format and sort by timestamp
    const chartData = data.map(point => ({
        x: new Date(point.x).toLocaleDateString(),
        y: point.y
    })).slice(0, 50); // Limit to 50 points for performance
    
    console.log('Chart data formatted:', chartData.slice(0, 3)); // Log first 3 points
    
    try {
        chart = new Chart(context, {
            type: 'line',
            data: {
                labels: chartData.map(point => point.x),
                datasets: [{
                    label: coinId.toUpperCase() + ' Price',
                    data: chartData.map(point => point.y),
                    borderColor: 'rgb(75, 192, 192)',
                    backgroundColor: 'rgba(75, 192, 192, 0.1)',
                    tension: 0.1,
                    fill: true,
                    pointRadius: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: false,
                        ticks: {
                            callback: function(value) {
                                return currencySymbol + value.toFixed(2);
                            }
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': ' + currencySymbol + context.parsed.y.toFixed(6);
                            }
                        }
                    },
                    legend: {
                        display: true,
                        position: 'top'
                    }
                }
            }
        });
        
        console.log('Chart created successfully');
    } catch (error) {
        console.error('Error creating chart:', error);
        ctx.parentElement.innerHTML = '<div class="alert alert-warning">Error creating chart: ' + error.message + '</div>';
    }
}

function calculateMovingAverage(data, period) {
    const ma = [];
    for (let i = 0; i < data.length; i++) {
        if (i < period - 1) {
            ma.push(null);
        } else {
            let sum = 0;
            for (let j = i - period + 1; j <= i; j++) {
                sum += data[j].y;
            }
            ma.push({
                x: data[i].x,
                y: sum / period
            });
        }
    }
    return ma;
}

function calculateTechnicalIndicators(data) {
    if (data.length < 14) return;
    
    // Calculate RSI
    const rsi = calculateRSI(data, 14);
    document.getElementById('rsi').textContent = rsi.toFixed(2);
    
    // Calculate moving averages
    const ma20 = calculateSimpleMA(data, 20);
    const ma50 = calculateSimpleMA(data, 50);
    
    document.getElementById('ma20').textContent = ma20 ? '$' + ma20.toFixed(2) : '-';
    document.getElementById('ma50').textContent = ma50 ? '$' + ma50.toFixed(2) : '-';
    
    // Calculate volatility
    const volatility = calculateVolatility(data);
    document.getElementById('volatility').textContent = volatility.toFixed(2) + '%';
}

function calculateRSI(data, period) {
    if (data.length < period + 1) return 50;
    
    let gains = 0;
    let losses = 0;
    
    for (let i = data.length - period; i < data.length; i++) {
        const change = data[i].y - data[i - 1].y;
        if (change > 0) {
            gains += change;
        } else {
            losses += Math.abs(change);
        }
    }
    
    const avgGain = gains / period;
    const avgLoss = losses / period;
    
    if (avgLoss === 0) return 100;
    
    const rs = avgGain / avgLoss;
    return 100 - (100 / (1 + rs));
}

function calculateSimpleMA(data, period) {
    if (data.length < period) return null;
    
    let sum = 0;
    for (let i = data.length - period; i < data.length; i++) {
        sum += data[i].y;
    }
    return sum / period;
}

function calculateVolatility(data) {
    if (data.length < 2) return 0;
    
    const returns = [];
    for (let i = 1; i < data.length; i++) {
        returns.push((data[i].y - data[i - 1].y) / data[i - 1].y);
    }
    
    const mean = returns.reduce((a, b) => a + b, 0) / returns.length;
    const variance = returns.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / returns.length;
    
    return Math.sqrt(variance) * 100;
}

function loadPriceStats() {
    // This would typically come from a more detailed API endpoint
    // For now, we'll use placeholder values
    fetch('/api/prices')
        .then(response => response.json())
        .then(data => {
            if (data[coinId]) {
                const price = data[coinId];
                // These would come from a more detailed API
                document.getElementById('high24h').textContent = '$' + (price.usd * 1.05).toFixed(2);
                document.getElementById('low24h').textContent = '$' + (price.usd * 0.95).toFixed(2);
                document.getElementById('volume24h').textContent = '$' + (Math.random() * 1000000000).toFixed(0);
                document.getElementById('marketCap').textContent = '$' + (Math.random() * 100000000000).toFixed(0);
            }
        });
}

function quickBuy() {
    fetch('/api/buy_coin', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ coin_id: coinId, amount: 100 })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Successfully bought $100 worth of ' + coinId.toUpperCase());
        } else {
            alert('Error: ' + data.error);
        }
    });
}

function setAlert() {
    new bootstrap.Modal(document.getElementById('alertModal')).show();
}

function saveAlert() {
    const price = document.getElementById('alertPrice').value;
    const type = document.getElementById('alertType').value;
    
    // Store in localStorage for demo
    const alerts = JSON.parse(localStorage.getItem('priceAlerts') || '{}');
    alerts[coinId] = { price: parseFloat(price), type };
    localStorage.setItem('priceAlerts', JSON.stringify(alerts));
    
    alert('Price alert set for ' + coinId.toUpperCase() + ' ' + type + ' $' + price);
    bootstrap.Modal.getInstance(document.getElementById('alertModal')).hide();
}

function addToFavorites() {
    const favorites = JSON.parse(localStorage.getItem('favorites') || '[]');
    if (!favorites.includes(coinId)) {
        favorites.push(coinId);
        localStorage.setItem('favorites', JSON.stringify(favorites));
        alert(coinId.toUpperCase() + ' added to favorites');
    } else {
        alert(coinId.toUpperCase() + ' is already in favorites');
    }
}

function testChart() {
    console.log('Testing chart functionality...');
    console.log('Chart.js available:', typeof Chart !== 'undefined');
    console.log('Canvas element:', document.getElementById('priceChart'));
    
    if (typeof Chart === 'undefined') {
        alert('Chart.js is not loaded!');
        return;
    }
    
    const canvas = document.getElementById('priceChart');
    if (!canvas) {
        alert('Canvas element not found!');
        return;
    }
    
    // Force create a simple test chart
    showPlaceholderChart();
    alert('Test chart created! Check the console for details.');
}
</script>

<style>
/* Chart container styling */
#priceChart {
    height: 400px !important;
    width: 100% !important;
}

.chart-container {
    position: relative;
    height: 400px;
    width: 100%;
}

.card-body canvas {
    max-height: 400px;
}

.card-header h6 {
    margin: 0;
    font-weight: 600;
}

.btn-group .btn.active {
    background-color: #0d6efd;
    color: white;
}
</style>
{% endif %}
{% endblock %}