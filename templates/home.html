{% extends "base.html" %}

{% block title %}Dashboard - CryptoPulse{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-chart-line me-2"></i>Cryptocurrency Dashboard</h2>
    <div class="d-flex gap-2">
        <select class="form-select" id="currencySelect" onchange="changeCurrency()" style="width: 120px;">
            {% for code, info in supported_currencies.items() %}
            <option value="{{ code }}" {% if code == currency %}selected{% endif %}>
                {{ info.symbol }} {{ code.upper() }}
            </option>
            {% endfor %}
        </select>
        <input type="text" id="searchInput" class="form-control" placeholder="Search coins..." style="width: 200px;">
        <button class="btn btn-outline-success" onclick="toggleFavoritesOnly()">
            <i class="fas fa-star"></i> Favorites
        </button>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#quickTradeModal">
            <i class="fas fa-bolt"></i> Quick Trade
        </button>
    </div>
</div>

<!-- Portfolio Summary Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-center bg-gradient-primary text-white">
            <div class="card-body">
                <h6 class="card-title mb-1"><i class="fas fa-wallet me-2"></i>Portfolio Value</h6>
                <h4 class="mb-0">{{ currency_symbol }}{{ "%.2f"|format(total_value) }}</h4>
                <small>Cash: {{ currency_symbol }}{{ "%.2f"|format(portfolio.balance) }}</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center bg-gradient-success text-white">
            <div class="card-body">
                <h6 class="card-title mb-1"><i class="fas fa-coins me-2"></i>Holdings Value</h6>
                <h4 class="mb-0">{{ currency_symbol }}{{ "%.2f"|format(holdings_value) }}</h4>
                <small>{{ portfolio.holdings|length }} Assets</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center {% if total_value - 10000 >= 0 %}bg-gradient-info{% else %}bg-gradient-danger{% endif %} text-white">
            <div class="card-body">
                <h6 class="card-title mb-1"><i class="fas fa-chart-line me-2"></i>Total P&L</h6>
                <h4 class="mb-0">
                    {% set pnl = total_value - 10000 %}
                    {% if pnl >= 0 %}+{% endif %}{{ currency_symbol }}{{ "%.2f"|format(pnl) }}
                </h4>
                <small>{{ "%.2f"|format((pnl / 10000) * 100) }}%</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center bg-gradient-warning text-white">
            <div class="card-body">
                <h6 class="card-title mb-1"><i class="fas fa-fire me-2"></i>Top Performer</h6>
                <h4 class="mb-0" id="topPerformer">Loading...</h4>
                <small id="topPerformerChange">--</small>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <h6 class="mb-3"><i class="fas fa-bolt me-2"></i>Quick Actions</h6>
                <div class="btn-group" role="group">
                    <a href="{{ url_for('portfolio') }}" class="btn btn-outline-primary">
                        <i class="fas fa-briefcase me-2"></i>My Portfolio
                    </a>
                    <a href="{{ url_for('charts') }}" class="btn btn-outline-info">
                        <i class="fas fa-chart-area me-2"></i>View Charts
                    </a>
                    <a href="{{ url_for('news') }}" class="btn btn-outline-success">
                        <i class="fas fa-newspaper me-2"></i>Crypto News
                    </a>
                    <button class="btn btn-outline-warning" data-bs-toggle="modal" data-bs-target="#priceAlertModal">
                        <i class="fas fa-bell me-2"></i>Set Alert
                    </button>
                    <button class="btn btn-outline-secondary" onclick="refreshPrices()">
                        <i class="fas fa-sync-alt me-2"></i>Refresh
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Market Overview & Watchlist -->
<div class="row mb-4">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="fas fa-list me-2"></i>Live Prices</h5>
                <div class="d-flex gap-2">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="autoRefresh" checked>
                        <label class="form-check-label" for="autoRefresh">Auto-refresh</label>
                    </div>
                    <button class="btn btn-sm btn-outline-primary" onclick="refreshPrices()">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover" id="pricesTable">
                        <thead>
                            <tr>
                                <th>Coin</th>
                                <th>Price</th>
                                <th>24h Change</th>
                                <th>Market Cap</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for coin_id in tracked_coins %}
                            {% if coin_id in prices %}
                            {% set coin_data = prices[coin_id] %}
                            <tr>
                                <td>
                                    <button class="btn btn-sm btn-link p-0" onclick="toggleFavorite('{{ coin_id }}')">
                                        <i class="far fa-star favorite-icon" id="fav-{{ coin_id }}"></i>
                                    </button>
                                    <strong>{{ coin_id.title() }}</strong>
                                </td>
                                <td>{{ currency_symbol }}{{ "%.2f"|format(coin_data[currency]) }}</td>
                                <td class="{% if coin_data[currency + '_24h_change'] >= 0 %}text-success{% else %}text-danger{% endif %}">
                                    {% if coin_data[currency + '_24h_change'] >= 0 %}
                                    <i class="fas fa-arrow-up"></i>
                                    {% else %}
                                    <i class="fas fa-arrow-down"></i>
                                    {% endif %}
                                    {{ "%.2f"|format(coin_data[currency + '_24h_change']) }}%
                                </td>
                                <td>{{ currency_symbol }}{{ "{:,.0f}".format(coin_data.get(currency + '_market_cap', 0)) }}</td>
                                <td>
                                    <button class="btn btn-sm btn-success" onclick="quickBuy('{{ coin_id }}')">
                                        <i class="fas fa-shopping-cart"></i>
                                    </button>
                                    <a href="{{ url_for('charts', coin_id=coin_id) }}" class="btn btn-sm btn-info" target="_blank">
                                        <i class="fas fa-chart-line"></i>
                                    </a>
                                </td>
                            </tr>
                            {% endif %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <!-- My Holdings Widget -->
        <div class="card mb-3">
            <div class="card-header bg-primary text-white">
                <h6 class="mb-0"><i class="fas fa-briefcase me-2"></i>My Holdings</h6>
            </div>
            <div class="card-body">
                {% if portfolio.holdings %}
                <div class="list-group list-group-flush">
                    {% for coin_id, quantity in portfolio.holdings.items() %}
                    {% if coin_id in prices %}
                    <div class="list-group-item px-0">
                        <div class="d-flex justify-content-between">
                            <strong>{{ coin_id.title() }}</strong>
                            <span>{{ "%.4f"|format(quantity) }}</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <small class="text-muted">{{ currency_symbol }}{{ "%.2f"|format(prices[coin_id][currency]) }}</small>
                            <small class="fw-bold">{{ currency_symbol }}{{ "%.2f"|format(prices[coin_id][currency] * quantity) }}</small>
                        </div>
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
                <a href="{{ url_for('portfolio') }}" class="btn btn-primary btn-sm w-100 mt-2">
                    View Full Portfolio
                </a>
                {% else %}
                <div class="text-center py-3">
                    <i class="fas fa-wallet fa-2x text-muted mb-2"></i>
                    <p class="text-muted mb-2">No holdings yet</p>
                    <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#quickTradeModal">
                        Start Trading
                    </button>
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Market Stats Widget -->
        <div class="card">
            <div class="card-header bg-info text-white">
                <h6 class="mb-0"><i class="fas fa-chart-pie me-2"></i>Market Stats</h6>
            </div>
            <div class="card-body">
                <div class="mb-2">
                    <small class="text-muted">Coins Tracked</small>
                    <h5>{{ tracked_coins|length }}</h5>
                </div>
                <div class="mb-2">
                    <small class="text-muted">Gainers (24h)</small>
                    <h5 class="text-success" id="gainersCount">--</h5>
                </div>
                <div class="mb-2">
                    <small class="text-muted">Losers (24h)</small>
                    <h5 class="text-danger" id="losersCount">--</h5>
                </div>
                <div>
                    <small class="text-muted">Last Updated</small>
                    <p class="mb-0" id="lastUpdated">Just now</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Trade Modal -->
<div class="modal fade" id="quickTradeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-bolt me-2"></i>Quick Trade</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Select Coin</label>
                    <select class="form-control" id="quickTradeCoin">
                        {% for coin in tracked_coins %}
                        <option value="{{ coin }}">{{ coin.title() }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Amount ({{ currency_symbol }})</label>
                    <input type="number" class="form-control" id="quickTradeAmount" min="1" step="0.01">
                </div>
                <div class="d-grid gap-2">
                    <button class="btn btn-success" onclick="executeQuickBuy()">
                        <i class="fas fa-shopping-cart me-2"></i>Buy Now
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Price Alert Modal -->
<div class="modal fade" id="priceAlertModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-bell me-2"></i>Set Price Alert</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Select Coin</label>
                    <select class="form-control" id="alertCoin">
                        {% for coin in tracked_coins %}
                        <option value="{{ coin }}">{{ coin.title() }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Target Price ({{ currency_symbol }})</label>
                    <input type="number" class="form-control" id="alertPrice" step="0.01">
                </div>
                <div class="mb-3">
                    <label class="form-label">Alert Type</label>
                    <select class="form-control" id="alertType">
                        <option value="above">Price goes above</option>
                        <option value="below">Price goes below</option>
                    </select>
                </div>
                <div class="d-grid">
                    <button class="btn btn-warning" onclick="setAlert()">
                        <i class="fas fa-bell me-2"></i>Create Alert
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Calculate market stats
document.addEventListener('DOMContentLoaded', function() {
    calculateMarketStats();
    if (document.getElementById('autoRefresh').checked) {
        setInterval(refreshPrices, 30000); // Refresh every 30 seconds
    }
});

function calculateMarketStats() {
    const prices = {{ prices|tojson|safe }};
    const currency = '{{ currency }}';
    
    let gainers = 0;
    let losers = 0;
    let topChange = -Infinity;
    let topCoin = '';
    
    for (const [coin, data] of Object.entries(prices)) {
        const change = data[currency + '_24h_change'];
        if (change > 0) gainers++;
        if (change < 0) losers++;
        if (change > topChange) {
            topChange = change;
            topCoin = coin;
        }
    }
    
    document.getElementById('gainersCount').textContent = gainers;
    document.getElementById('losersCount').textContent = losers;
    document.getElementById('topPerformer').textContent = topCoin.toUpperCase();
    document.getElementById('topPerformerChange').textContent = '+' + topChange.toFixed(2) + '%';
}

function changeCurrency() {
    const currency = document.getElementById('currencySelect').value;
    fetch('/api/set_currency', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ currency: currency })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        }
    });
}

function refreshPrices() {
    location.reload();
}

function toggleFavorite(coinId) {
    const icon = document.getElementById('fav-' + coinId);
    icon.classList.toggle('far');
    icon.classList.toggle('fas');
    // Save to localStorage
    let favorites = JSON.parse(localStorage.getItem('favorites') || '[]');
    if (favorites.includes(coinId)) {
        favorites = favorites.filter(c => c !== coinId);
    } else {
        favorites.push(coinId);
    }
    localStorage.setItem('favorites', JSON.stringify(favorites));
}

function toggleFavoritesOnly() {
    // Filter table to show only favorites
    alert('Favorites filter coming soon!');
}

function quickBuy(coinId) {
    document.getElementById('quickTradeCoin').value = coinId;
    new bootstrap.Modal(document.getElementById('quickTradeModal')).show();
}

function executeQuickBuy() {
    const coin = document.getElementById('quickTradeCoin').value;
    const amount = document.getElementById('quickTradeAmount').value;
    
    if (!amount || amount <= 0) {
        alert('Please enter a valid amount');
        return;
    }
    
    fetch('/api/buy_coin', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ coin_id: coin, amount: parseFloat(amount) })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Successfully bought ' + coin.toUpperCase());
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    });
}

function setAlert() {
    alert('Price alerts feature coming soon!');
}

// Search functionality
document.getElementById('searchInput').addEventListener('input', function() {
    const searchTerm = this.value.toLowerCase();
    const rows = document.querySelectorAll('#pricesTable tbody tr');
    
    rows.forEach(row => {
        const coinName = row.cells[0].textContent.toLowerCase();
        if (coinName.includes(searchTerm)) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
});

// Load favorites on page load
document.addEventListener('DOMContentLoaded', function() {
    const favorites = JSON.parse(localStorage.getItem('favorites') || '[]');
    favorites.forEach(coinId => {
        const icon = document.getElementById('fav-' + coinId);
        if (icon) {
            icon.classList.remove('far');
            icon.classList.add('fas');
        }
    });
});
</script>

<style>
.bg-gradient-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}
.bg-gradient-success {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
}
.bg-gradient-info {
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
}
.bg-gradient-warning {
    background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
}
.bg-gradient-danger {
    background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
}
.favorite-icon {
    color: #ffc107;
    cursor: pointer;
}
.favorite-icon:hover {
    transform: scale(1.2);
}
</style>
{% endblock %}