{% extends "base.html" %}

{% block title %}Dashboard - CryptoPulse{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Cryptocurrency Dashboard</h2>
    <div class="d-flex gap-2">
        <select class="form-select" id="currencySelect" onchange="changeCurrency()" style="width: 120px;">
            {% for code, info in supported_currencies.items() %}
            <option value="{{ code }}" {% if code == currency %}selected{% endif %}>
                {{ info.symbol }} {{ code.upper() }}
            </option>
            {% endfor %}
        </select>
        <input type="text" id="searchInput" class="form-control" placeholder="Search coins..." style="width: 200px;">
        <button class="btn btn-outline-success" onclick="toggleFavoritesOnly()">
            <i class="fas fa-star"></i> Favorites
        </button>
    </div>
</div>

<!-- Market Overview Cards -->
<div class="row mb-4">
    <div class="col-md-2">
        <div class="card text-center bg-primary text-white">
            <div class="card-body py-2">
                <h6 class="card-title mb-1">Market Cap</h6>
                <h5 id="globalMarketCap">Loading...</h5>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card text-center bg-info text-white">
            <div class="card-body py-2">
                <h6 class="card-title mb-1">24h Volume</h6>
                <h5 id="globalVolume">Loading...</h5>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card text-center bg-warning text-white">
            <div class="card-body py-2">
                <h6 class="card-title mb-1">BTC Dom.</h6>
                <h5 id="btcDominance">Loading...</h5>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card text-center bg-success text-white">
            <div class="card-body py-2">
                <h6 class="card-title mb-1">Fear & Greed</h6>
                <h5 id="fearGreedIndex">Loading...</h5>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card text-center bg-secondary text-white">
            <div class="card-body py-2">
                <h6 class="card-title mb-1">Active Coins</h6>
                <h5 id="activeCryptos">Loading...</h5>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card text-center bg-dark text-white">
            <div class="card-body py-2">
                <h6 class="card-title mb-1">Portfolio</h6>
                <h5 id="portfolioValue">$0.00</h5>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5>Live Prices</h5>
                <div class="d-flex gap-2">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="autoRefresh" checked>
                        <label class="form-check-label" for="autoRefresh">Auto-refresh</label>
                    </div>
                    <button class="btn btn-sm btn-outline-primary" onclick="refreshPrices()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover" id="pricesTable">
                        <thead>
                            <tr>
                                <th>
                                    <button class="btn btn-sm btn-link p-0 text-decoration-none" onclick="sortTable('name')">
                                        Coin <i class="fas fa-sort"></i>
                                    </button>
                                </th>
                                <th>
                                    <button class="btn btn-sm btn-link p-0 text-decoration-none" onclick="sortTable('price')">
                                        Price <i class="fas fa-sort"></i>
                                    </button>
                                </th>
                                <th>
                                    <button class="btn btn-sm btn-link p-0 text-decoration-none" onclick="sortTable('change')">
                                        24h Change <i class="fas fa-sort"></i>
                                    </button>
                                </th>
                                <th>Market Cap</th>
                                <th>Volume</th>
                                <th>Alert</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="pricesTableBody">
                            <!-- Prices will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Enhanced Price Alert Modal -->
<div class="modal fade" id="alertModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Set Price Alert</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="alertForm">
                    <input type="hidden" id="alertCoin">
                    <div class="mb-3">
                        <label for="alertPrice" class="form-label">Alert Price (USD)</label>
                        <input type="number" class="form-control" id="alertPrice" step="0.01" required>
                        <small class="text-muted" id="currentPriceInfo"></small>
                    </div>
                    <div class="mb-3">
                        <label for="alertType" class="form-label">Alert Type</label>
                        <select class="form-control" id="alertType">
                            <option value="above">Above (Price goes up)</option>
                            <option value="below">Below (Price goes down)</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="alertNotification" checked>
                            <label class="form-check-label" for="alertNotification">
                                Browser notification
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="alertSound">
                            <label class="form-check-label" for="alertSound">
                                Sound notification
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="setAlert()">Set Alert</button>
            </div>
        </div>
    </div>
</div>

<!-- Quick Buy Modal -->
<div class="modal fade" id="quickBuyModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Quick Buy</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="quickBuyForm">
                    <input type="hidden" id="quickBuyCoin">
                    <div class="mb-3">
                        <label class="form-label">Coin: <span id="quickBuyCoinName"></span></label>
                        <div class="alert alert-info" id="quickBuyInfo"></div>
                    </div>
                    <div class="mb-3">
                        <label for="quickBuyAmount" class="form-label">Amount (USD)</label>
                        <div class="btn-group w-100 mb-2" role="group">
                            <button type="button" class="btn btn-outline-primary" onclick="setQuickBuyAmount(25)">$25</button>
                            <button type="button" class="btn btn-outline-primary" onclick="setQuickBuyAmount(50)">$50</button>
                            <button type="button" class="btn btn-outline-primary" onclick="setQuickBuyAmount(100)">$100</button>
                            <button type="button" class="btn btn-outline-primary" onclick="setQuickBuyAmount(250)">$250</button>
                        </div>
                        <input type="number" class="form-control" id="quickBuyAmount" min="1" step="0.01" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="executeQuickBuy()">Buy Now</button>
            </div>
        </div>
    </div>
</div>

<script>
// Global variables
let currentPrices = {};
let sortDirection = {};
let favoritesOnly = false;
let autoRefreshInterval;
let favorites = JSON.parse(localStorage.getItem('favorites') || '[]');
let currentCurrency = '{{ currency }}';
let currencySymbol = '{{ currency_symbol }}';

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    loadPrices();
    loadMarketStats();
    loadPortfolioValue();
    
    // Setup auto-refresh
    setupAutoRefresh();
    
    // Request notification permission
    if ('Notification' in window && Notification.permission === 'default') {
        Notification.requestPermission();
    }
});

function changeCurrency() {
    const newCurrency = document.getElementById('currencySelect').value;
    
    // Update currency via API
    fetch('/api/set_currency', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ currency: newCurrency })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            currentCurrency = data.currency;
            currencySymbol = data.currency_symbol;
            
            // Reload prices with new currency
            loadPrices();
            loadMarketStats();
            
            showSuccess(`Currency changed to ${newCurrency.toUpperCase()}`);
        } else {
            showError('Failed to change currency');
        }
    })
    .catch(error => {
        console.error('Error changing currency:', error);
        showError('Failed to change currency');
    });
}

function setupAutoRefresh() {
    const autoRefreshCheckbox = document.getElementById('autoRefresh');
    
    function startAutoRefresh() {
        if (autoRefreshInterval) clearInterval(autoRefreshInterval);
        autoRefreshInterval = setInterval(() => {
            if (autoRefreshCheckbox.checked) {
                loadPrices();
                loadMarketStats();
                loadPortfolioValue();
            }
        }, 30000); // 30 seconds
    }
    
    startAutoRefresh();
    autoRefreshCheckbox.addEventListener('change', startAutoRefresh);
}

function loadPrices() {
    fetch('/api/prices?currency=' + currentCurrency)
        .then(response => response.json())
        .then(data => {
            if (data.prices) {
                currentPrices = data.prices;
                currencySymbol = data.currency_symbol;
                updatePricesTable(data.prices);
                checkPriceAlerts(data.prices);
            }
        })
        .catch(error => console.error('Error fetching prices:', error));
}

function loadMarketStats() {
    fetch('/api/market_stats')
        .then(response => response.json())
        .then(data => {
            if (!data.error) {
                document.getElementById('globalMarketCap').textContent = 
                    '$' + (data.total_market_cap / 1e12).toFixed(1) + 'T';
                document.getElementById('globalVolume').textContent = 
                    '$' + (data.total_volume / 1e9).toFixed(0) + 'B';
                document.getElementById('btcDominance').textContent = 
                    data.bitcoin_dominance.toFixed(1) + '%';
                document.getElementById('activeCryptos').textContent = 
                    data.active_cryptocurrencies.toLocaleString();
            }
        })
        .catch(error => console.error('Error loading market stats:', error));
    
    // Load Fear & Greed Index
    fetch('/api/fear_greed')
        .then(response => response.json())
        .then(data => {
            if (!data.error) {
                document.getElementById('fearGreedIndex').textContent = data.value;
            }
        })
        .catch(error => console.error('Error loading Fear & Greed:', error));
}

function loadPortfolioValue() {
    // This would typically come from a portfolio API endpoint
    // For now, we'll use a placeholder
    document.getElementById('portfolioValue').textContent = '$10,000';
}

function updatePricesTable(prices) {
    const tbody = document.getElementById('pricesTableBody');
    tbody.innerHTML = '';
    
    let coinsToShow = Object.keys(prices);
    
    // Filter by favorites if enabled
    if (favoritesOnly) {
        coinsToShow = coinsToShow.filter(coinId => favorites.includes(coinId));
    }
    
    coinsToShow.forEach(coinId => {
        const coin = prices[coinId];
        const row = document.createElement('tr');
        
        // Get price data for current currency
        const priceKey = currentCurrency;
        const changeKey = currentCurrency + '_24h_change';
        
        const currentPrice = coin[priceKey] || 0;
        const priceChange = coin[changeKey] || 0;
        
        const changeClass = priceChange > 0 ? 'text-success' : 'text-danger';
        const changeIcon = priceChange > 0 ? '↗' : '↘';
        const isFavorite = favorites.includes(coinId);
        
        // Mock market cap and volume data (would come from API in real implementation)
        const marketCap = (currentPrice * Math.random() * 1000000000).toFixed(0);
        const volume = (currentPrice * Math.random() * 100000000).toFixed(0);
        
        row.innerHTML = `
            <td class="coin-name">
                <div class="d-flex align-items-center">
                    <button class="btn btn-sm btn-link p-0 me-2" onclick="toggleFavorite('${coinId}')">
                        <i class="fas fa-star ${isFavorite ? 'text-warning' : 'text-muted'}"></i>
                    </button>
                    <strong>${coinId.charAt(0).toUpperCase() + coinId.slice(1)}</strong>
                </div>
            </td>
            <td class="price">${currencySymbol}${currentPrice.toLocaleString()}</td>
            <td class="${changeClass}">${changeIcon} ${priceChange.toFixed(2)}%</td>
            <td>${currencySymbol}${parseInt(marketCap).toLocaleString()}</td>
            <td>${currencySymbol}${parseInt(volume).toLocaleString()}</td>
            <td><span class="alert-status" data-coin="${coinId}">No Alert</span></td>
            <td>
                <div class="btn-group btn-group-sm" role="group">
                    <button class="btn btn-outline-warning" onclick="showAlertModal('${coinId}')">
                        Alert
                    </button>
                    <button class="btn btn-outline-success" onclick="showQuickBuyModal('${coinId}')">
                        Buy
                    </button>
                    <button class="btn btn-outline-info" onclick="viewChart('${coinId}')">
                        Chart
                    </button>
                </div>
            </td>
        `;
        
        tbody.appendChild(row);
    });
    
    // Update alert statuses
    updateAlertStatuses();
}

function toggleFavorite(coinId) {
    if (favorites.includes(coinId)) {
        favorites = favorites.filter(id => id !== coinId);
    } else {
        favorites.push(coinId);
    }
    
    localStorage.setItem('favorites', JSON.stringify(favorites));
    updatePricesTable(currentPrices);
}

function toggleFavoritesOnly() {
    favoritesOnly = !favoritesOnly;
    const button = event.target.closest('button');
    
    if (favoritesOnly) {
        button.classList.remove('btn-outline-success');
        button.classList.add('btn-success');
    } else {
        button.classList.remove('btn-success');
        button.classList.add('btn-outline-success');
    }
    
    updatePricesTable(currentPrices);
}

function sortTable(column) {
    const direction = sortDirection[column] === 'asc' ? 'desc' : 'asc';
    sortDirection[column] = direction;
    
    // Sorting logic would be implemented here
    console.log(`Sorting by ${column} in ${direction} order`);
}

function showAlertModal(coinId) {
    document.getElementById('alertCoin').value = coinId;
    document.getElementById('currentPriceInfo').textContent = 
        `Current price: $${currentPrices[coinId].usd.toFixed(2)}`;
    new bootstrap.Modal(document.getElementById('alertModal')).show();
}

function showQuickBuyModal(coinId) {
    document.getElementById('quickBuyCoin').value = coinId;
    document.getElementById('quickBuyCoinName').textContent = coinId.toUpperCase();
    document.getElementById('quickBuyInfo').textContent = 
        `Current price: $${currentPrices[coinId].usd.toFixed(2)}`;
    new bootstrap.Modal(document.getElementById('quickBuyModal')).show();
}

function setQuickBuyAmount(amount) {
    document.getElementById('quickBuyAmount').value = amount;
}

function executeQuickBuy() {
    const coinId = document.getElementById('quickBuyCoin').value;
    const amount = parseFloat(document.getElementById('quickBuyAmount').value);
    
    if (!amount || amount <= 0) {
        alert('Please enter a valid amount');
        return;
    }
    
    fetch('/api/buy_coin', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ coin_id: coinId, amount: amount })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccess(`Successfully bought $${amount} worth of ${coinId.toUpperCase()}`);
            loadPortfolioValue();
        } else {
            showError(data.error);
        }
    })
    .catch(error => showError('Transaction failed'));
    
    bootstrap.Modal.getInstance(document.getElementById('quickBuyModal')).hide();
}

function setAlert() {
    const coin = document.getElementById('alertCoin').value;
    const price = parseFloat(document.getElementById('alertPrice').value);
    const type = document.getElementById('alertType').value;
    const notification = document.getElementById('alertNotification').checked;
    const sound = document.getElementById('alertSound').checked;
    
    if (!price || price <= 0) {
        alert('Please enter a valid price');
        return;
    }
    
    // Store alert in localStorage
    const alerts = JSON.parse(localStorage.getItem('priceAlerts') || '{}');
    alerts[coin] = { price, type, notification, sound };
    localStorage.setItem('priceAlerts', JSON.stringify(alerts));
    
    // Update UI
    updateAlertStatuses();
    
    showSuccess(`Price alert set for ${coin.toUpperCase()} ${type} $${price}`);
    bootstrap.Modal.getInstance(document.getElementById('alertModal')).hide();
}

function updateAlertStatuses() {
    const alerts = JSON.parse(localStorage.getItem('priceAlerts') || '{}');
    
    Object.keys(alerts).forEach(coin => {
        const alertSpan = document.querySelector(`[data-coin="${coin}"]`);
        if (alertSpan) {
            const alert = alerts[coin];
            alertSpan.textContent = `${alert.type} $${alert.price}`;
            alertSpan.className = 'alert-status badge bg-warning';
        }
    });
}

function checkPriceAlerts(prices) {
    const alerts = JSON.parse(localStorage.getItem('priceAlerts') || '{}');
    
    Object.keys(alerts).forEach(coin => {
        if (prices[coin]) {
            const alert = alerts[coin];
            const currentPrice = prices[coin].usd;
            const alertTriggered = 
                (alert.type === 'above' && currentPrice >= alert.price) ||
                (alert.type === 'below' && currentPrice <= alert.price);

            if (alertTriggered) {
                triggerAlert(coin, currentPrice, alert);
            }
        }
    });
}

function triggerAlert(coin, price, alert) {
    // Visual alert
    const row = document.querySelector(`[data-coin="${coin}"]`).closest('tr');
    if (row) {
        row.classList.add(alert.type === 'above' ? 'price-alert-high' : 'price-alert-low');
        setTimeout(() => {
            row.classList.remove('price-alert-high', 'price-alert-low');
        }, 3000);
    }

    // Browser notification
    if (alert.notification && Notification.permission === 'granted') {
        new Notification(`Price Alert: ${coin.toUpperCase()}`, {
            body: `Price is now $${price.toLocaleString()} (${alert.type} $${alert.price})`,
            icon: '/static/favicon.ico'
        });
    }
    
    // Sound notification
    if (alert.sound) {
        // Play a simple beep sound
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.value = 800;
        oscillator.type = 'sine';
        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
        
        oscillator.start();
        oscillator.stop(audioContext.currentTime + 0.2);
    }
}

function viewChart(coinId) {
    window.open(`/charts/${coinId}`, '_blank');
}

function refreshPrices() {
    loadPrices();
    loadMarketStats();
    loadPortfolioValue();
}

function showSuccess(message) {
    const alert = document.createElement('div');
    alert.className = 'alert alert-success alert-dismissible fade show position-fixed';
    alert.style.cssText = 'top: 20px; right: 20px; z-index: 9999;';
    alert.innerHTML = `${message}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
    document.body.appendChild(alert);
    setTimeout(() => alert.remove(), 3000);
}

function showError(message) {
    const alert = document.createElement('div');
    alert.className = 'alert alert-danger alert-dismissible fade show position-fixed';
    alert.style.cssText = 'top: 20px; right: 20px; z-index: 9999;';
    alert.innerHTML = `${message}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
    document.body.appendChild(alert);
    setTimeout(() => alert.remove(), 3000);
}

// Search functionality
document.getElementById('searchInput').addEventListener('input', function(e) {
    const searchTerm = e.target.value.toLowerCase();
    const rows = document.querySelectorAll('#pricesTableBody tr');
    
    rows.forEach(row => {
        const coinName = row.querySelector('.coin-name').textContent.toLowerCase();
        row.style.display = coinName.includes(searchTerm) ? '' : 'none';
    });
});
</script>
{% endblock %}